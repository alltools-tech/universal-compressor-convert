<!DOCTYPE html>
<html lang="en">
<head>
  <title>Universal Compressor/Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #eef3f9; }
    .container-box { max-width: 560px; margin: 2em auto; background: #fff; border-radius: 13px; box-shadow: 0 2px 14px #2222; padding: 2em; }
    .preview-frame { width: 340px; height: 260px; margin: 1em auto; background: #fafbfc; border-radius: 8px; border: 1px solid #cfd8dc; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;}
    .preview-img { max-width: 100%; max-height: 100%; border-radius: 6px; border: none; cursor: pointer; transition: box-shadow .2s; }
    .file-info, .compressed-info { margin: 1em 0; font-size: 1em; color: #195a6d;}
    .error { color: #d32f2f; margin-top: .7em; text-align: center;}
  </style>
</head>
<body>
  <div class="container container-box">
    <h2 class="text-center mb-4 text-primary">Universal Compressor/Converter</h2>
    <div class="mb-3 text-center">
      <input type="file" id="fileInput" class="form-control" multiple accept="application/pdf,image/jpeg,image/png,image/webp,image/avif,image/svg+xml,image/bmp,image/x-ms-bmp,image/*" />
    </div>
    <div class="file-info" id="fileInfo"></div>
    <div class="preview-frame" id="previewFrame" style="display:none;">
      <img id="imgPreview" class="preview-img" style="display:none;" />
    </div>
    <div class="mb-4 text-center" id="actionRow" style="display:none;">
      <button id="compressPdfBtn" class="btn btn-primary" style="display:none;">Compress PDF (True)</button>
      <button id="convertImagesBtn" class="btn btn-primary" style="display:none;">Convert Images to PDF</button>
    </div>
    <div class="error" id="errorMsg"></div>
    <div class="compressed-section" id="compressedSection" style="display:none;">
      <div class="file-info" id="compressedInfo"></div>
      <div class="text-center">
        <button id="downloadBtn" class="btn btn-success" style="display:none;">Download</button>
      </div>
    </div>
  </div>
  <script>
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const imgPreview = document.getElementById('imgPreview');
    const previewFrame = document.getElementById('previewFrame');
    const actionRow = document.getElementById('actionRow');
    const compressPdfBtn = document.getElementById('compressPdfBtn');
    const convertImagesBtn = document.getElementById('convertImagesBtn');
    const errorMsg = document.getElementById('errorMsg');
    const compressedSection = document.getElementById('compressedSection');
    const compressedInfo = document.getElementById('compressedInfo');
    const downloadBtn = document.getElementById('downloadBtn');

    let files = [];
    let compressedBlob = null;
    let compressedDataUrl = null;
    let compressedFilename = null;

    fileInput.onchange = function(e) {
      files = Array.from(e.target.files);
      resetUI();
      if (!files.length) return;

      // PDF or images? Detect first file
      let isPdf = files.length === 1 && (files[0].type === "application/pdf" || files[0].name.toLowerCase().endsWith(".pdf"));
      let isImages = files.every(f => f.type.startsWith("image/") || /\.(jpg|jpeg|png|webp|avif|svg|bmp)$/i.test(f.name));
      let ext = files[0].name.split('.').pop().toLowerCase();

      let info = files.map(f => {
        let type = f.type || f.name.split('.').pop();
        return `${f.name} (${type}, ${(f.size/1024).toFixed(2)} KB)`;
      }).join("<br>");
      fileInfo.innerHTML = info;

      if (isPdf) {
        previewFrame.style.display = "none";
        imgPreview.style.display = "none";
        actionRow.style.display = "block";
        compressPdfBtn.style.display = "inline-block";
        convertImagesBtn.style.display = "none";
      } else if (isImages) {
        showImagePreview(files[0]);
        actionRow.style.display = "block";
        compressPdfBtn.style.display = "none";
        convertImagesBtn.style.display = "inline-block";
      } else {
        errorMsg.textContent = "Unsupported file type.";
        actionRow.style.display = "none";
      }
    };

    function resetUI() {
      fileInfo.innerHTML = '';
      imgPreview.style.display = 'none';
      previewFrame.style.display = 'none';
      actionRow.style.display = 'none';
      errorMsg.textContent = '';
      compressedSection.style.display = 'none';
      compressedInfo.textContent = '';
      downloadBtn.style.display = 'none';
      compressedBlob = null;
      compressedDataUrl = null;
      compressedFilename = null;
    }

    // Show preview for images (first image only)
    function showImagePreview(file) {
      previewFrame.style.display = "flex";
      imgPreview.style.display = "block";
      if (file.type === "image/svg+xml" || /\.svg$/i.test(file.name)) {
        const reader = new FileReader();
        reader.onload = function(e) {
          imgPreview.src = "data:image/svg+xml;base64," + btoa(e.target.result);
        };
        reader.readAsText(file);
      } else {
        const reader = new FileReader();
        reader.onload = function(e) {
          imgPreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    // Compress PDF (True, backend)
    compressPdfBtn.onclick = async function() {
      errorMsg.textContent = "Compressing PDF...";
      let fd = new FormData();
      fd.append("pdf", files[0]);
      try {
        const resp = await fetch("/compress-pdf", { method: "POST", body: fd });
        if (!resp.ok) throw new Error("Compression failed");
        compressedBlob = await resp.blob();
        compressedDataUrl = URL.createObjectURL(compressedBlob);
        compressedFilename = files[0].name.replace(/\.pdf$/i, ".compressed.pdf");
        compressedInfo.innerHTML = `Compressed PDF: ${compressedFilename} (${(compressedBlob.size/1024).toFixed(2)} KB)`;
        compressedSection.style.display = "block";
        downloadBtn.style.display = "inline-block";
        errorMsg.textContent = "";
      } catch (e) {
        errorMsg.textContent = "Compression failed: " + e;
      }
    };

    // Convert Images to PDF (True, backend)
    convertImagesBtn.onclick = async function() {
      errorMsg.textContent = "Converting images to PDF...";
      let fd = new FormData();
      files.forEach((f,i) => fd.append("image"+i, f));
      try {
        const resp = await fetch("/images-to-pdf", { method: "POST", body: fd });
        if (!resp.ok) throw new Error("Conversion failed");
        compressedBlob = await resp.blob();
        compressedDataUrl = URL.createObjectURL(compressedBlob);
        compressedFilename = "converted.pdf";
        compressedInfo.innerHTML = `PDF: ${compressedFilename} (${(compressedBlob.size/1024).toFixed(2)} KB)`;
        compressedSection.style.display = "block";
        downloadBtn.style.display = "inline-block";
        errorMsg.textContent = "";
      } catch (e) {
        errorMsg.textContent = "Conversion failed: " + e;
      }
    };

    downloadBtn.onclick = function() {
      if (!compressedBlob) return;
      const a = document.createElement('a');
      a.href = compressedDataUrl;
      a.download = compressedFilename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{URL.revokeObjectURL(compressedDataUrl)}, 1000);
      document.body.removeChild(a);
    };
  </script>
</body>
</html>
